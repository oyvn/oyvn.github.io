<!DOCTYPE html>
<html lang="en">

<head><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<link href="https://fonts.googleapis.com/css?family=Merriweather:300|Raleway:400,700" rel="stylesheet">
<link rel="stylesheet" href="/assets/css/style.css">
<link rel="shortcut icon" type="image/png" href="/favicon.png">
<title>Multi-room audio with Snapcast and Raspberry Pi</title>
<!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Multi-room audio with Snapcast and Raspberry Pi | oyvn</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Multi-room audio with Snapcast and Raspberry Pi" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Snapcast is an open-source project that streams audio over network so it can be played synchronously, like Sonos. I recently set it up at home with some Raspberry Pis to play Spotify around my apartment. Here’s how I did it. I tried to show my work, so hopefully people can follow along (I’m no Raspberry Pi/Linux expert myself)." />
<meta property="og:description" content="Snapcast is an open-source project that streams audio over network so it can be played synchronously, like Sonos. I recently set it up at home with some Raspberry Pis to play Spotify around my apartment. Here’s how I did it. I tried to show my work, so hopefully people can follow along (I’m no Raspberry Pi/Linux expert myself)." />
<link rel="canonical" href="https://oyvn.github.io/multi-room-audio-with-snapcast" />
<meta property="og:url" content="https://oyvn.github.io/multi-room-audio-with-snapcast" />
<meta property="og:site_name" content="oyvn" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-05-22T21:00:00+02:00" />
<script type="application/ld+json">
{"mainEntityOfPage":{"@type":"WebPage","@id":"https://oyvn.github.io/multi-room-audio-with-snapcast"},"@type":"BlogPosting","url":"https://oyvn.github.io/multi-room-audio-with-snapcast","dateModified":"2020-05-22T21:00:00+02:00","datePublished":"2020-05-22T21:00:00+02:00","headline":"Multi-room audio with Snapcast and Raspberry Pi","description":"Snapcast is an open-source project that streams audio over network so it can be played synchronously, like Sonos. I recently set it up at home with some Raspberry Pis to play Spotify around my apartment. Here’s how I did it. I tried to show my work, so hopefully people can follow along (I’m no Raspberry Pi/Linux expert myself).","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
</head>

<body>
  <main class="container">
    <section class="about">
      <a href="/"><img src="/assets/portfolio.png" alt="Oh yes, very nerd"></a>
      <h2 id="title">
        <a href="/">Oh yes, very nerd</a>
      </h2>
      <p class="tagline"></p>
      <ul class="social"></ul><nav class="navigation">
        <ul>
          
          <li>
            <a href="/index">Home</a>
          </li>
          
          <li>
            <a href="/about">About</a>
          </li>
          
        </ul>
      </nav><p>&copy;
        2020</p></section>
    <section class="content">
      <div class="post-container">
  <a class="post-link" href="/multi-room-audio-with-snapcast">
    <h2 class="post-title">Multi-room audio with Snapcast and Raspberry Pi</h2>
  </a>
  <div class="post-meta">
    <div class="post-date"><i class="icon-calendar"></i>May 22, 2020</div><ul class="post-categories"><li>raspberrypi</li><li>snapcast</li><li>spotify</li><li>audio</li><li>tutorial</li></ul></div>
  <div class="post">
    <p><a href="https://github.com/badaix/snapcast">Snapcast</a> is an open-source project that streams audio over network so it can be played synchronously, like Sonos.
I recently set it up at home with some Raspberry Pis to play Spotify around my apartment. Here’s how I did it.
I tried to show my work, so hopefully people can follow along (I’m no Raspberry Pi/Linux expert myself).</p>

<p><strong>Table of Contents</strong>:</p>
<ul id="markdown-toc">
  <li><a href="#software-and-hardware-overview" id="markdown-toc-software-and-hardware-overview">Software and hardware overview</a></li>
  <li><a href="#prepare-the-software" id="markdown-toc-prepare-the-software">Prepare the software</a>    <ul>
      <li><a href="#snapcast" id="markdown-toc-snapcast">Snapcast</a></li>
      <li><a href="#librespot" id="markdown-toc-librespot">Librespot</a></li>
    </ul>
  </li>
  <li><a href="#prepare-the-raspberry-pis" id="markdown-toc-prepare-the-raspberry-pis">Prepare the Raspberry Pis</a></li>
  <li><a href="#assemble-the-hardware" id="markdown-toc-assemble-the-hardware">Assemble the hardware</a></li>
  <li><a href="#configure-the-raspberry-pis" id="markdown-toc-configure-the-raspberry-pis">Configure the Raspberry Pis</a></li>
  <li><a href="#install-snapcast-and-librespot" id="markdown-toc-install-snapcast-and-librespot">Install Snapcast and Librespot</a>    <ul>
      <li><a href="#clients" id="markdown-toc-clients">Clients</a></li>
      <li><a href="#server" id="markdown-toc-server">Server</a></li>
    </ul>
  </li>
  <li><a href="#play-music" id="markdown-toc-play-music">Play music</a>    <ul>
      <li><a href="#snapdroid" id="markdown-toc-snapdroid">Snapdroid</a></li>
      <li><a href="#snapnet" id="markdown-toc-snapnet">Snap.Net</a></li>
    </ul>
  </li>
</ul>

<h1 id="software-and-hardware-overview">Software and hardware overview</h1>

<p>Here are the software projects involved:</p>

<ul>
  <li><a href="https://github.com/badaix/snapcast">Snapcast</a></li>
  <li><a href="https://github.com/badaix/snapdroid">Snapdroid</a> - Android app, available on Google Play.</li>
  <li><a href="https://github.com/stijnvdb88/Snap.Net">Snap.Net</a> - Windows snapcast client</li>
  <li><a href="https://github.com/librespot-org/librespot">Librespot</a> - Spotify client</li>
  <li><a href="https://github.com/raspberrypi/tools">Raspberry Pi Tools</a> - For cross compiling for Raspberry Pi Zero W.</li>
  <li><a href="https://www.raspberrypi.org/downloads/raspbian/">Raspbian</a></li>
  <li><a href="https://www.balena.io/etcher/">balenaEtcher</a> - For programming Raspbian onto the memory card.</li>
  <li><a href="https://docs.microsoft.com/en-us/windows/wsl/about">Windows Subsystem for Linux</a> - For Windows users, to SSH into the Raspberry Pis, and to compile Librespot. It might be possible without (using Putty, and compiling natively in Windows), but the instructions assume a Linux environment, and I did it in WSL.</li>
  <li><a href="www.spotify.com/">Spotify</a> - For the Spotify setup to work, you need a paid Spotify account. Snapcast work with lots of other audio stream sources as well (see the docs).</li>
</ul>

<p>And the hardware I used:</p>

<ul>
  <li><a href="https://www.adafruit.com/product/3708">Raspberry Pi Zero W</a> - Get the ‘h’ variant to avoid soldering. Any other Raspberry Pi will also work. You need one Pi for each speaker setup and one to serve as an snapcast server. I happened to have an old Raspberry Pi 1 lying around that I used as a server, but using one of the Zeros as both a server and a client should work OK, I tried it at one point with the Raspberry Pi 1.</li>
  <li>Micro SD cards for the Raspberry Pis. I use 32 GB, but 16 GB should work as well (8 GB might give you trouble).</li>
  <li><a href="https://www.hifiberry.com/shop/boards/hifiberry-dac-zero/">HifiBerry DAC+ Zero</a> - DAC (audio) shield for the Raspberry Pi Zero since it doesn’t have build in audio. You don’t need a DAC if you have built in audio, although it might give you slightly better sound.</li>
  <li><a href="https://www.clasohlson.com/no/DAB%2B-FM-radio-med-Bluetooth-Exibel-X50/p/Pr388182000">Exibel X50</a> - Radio with line in (3.5 mm jack) and USB power. But you can use anything that can receive audio.</li>
  <li>Audio cables (the HifiBerry gives RCA out, so I’m using an RCA to jack cable, check what your speaker setup needs).</li>
  <li>USB power sources and cables for the Pis.</li>
  <li>Memory card reader to program Raspbian onto the Raspberry Pis.</li>
</ul>

<h1 id="prepare-the-software">Prepare the software</h1>

<h2 id="snapcast">Snapcast</h2>

<p>Snapcast consists of two different programs: snapserver and snapclient.
Both are available in Raspbian’s package manager, but the versions are outdated (currently 0.15.0), so we will instead download the <a href="https://github.com/badaix/snapcast/releases">newest release</a> from Github (currently 0.19.0).
Download the “_armhf.deb” variant of both snapserver and snapclient.</p>

<h2 id="librespot">Librespot</h2>

<p>Librespot unfortunately doesn’t have builds available, so we need to compile it ourselves.
Don’t worry though, I found this pretty straightforward to do.
It’s written in Rust, which has a very streamlined build environment.</p>

<p>We need to compile it for the Raspberry Pi, but we don’t want to compile it <em>on</em> the Raspberry Pi because it takes too long.
I tried on my Raspberry Pi 1 (comparable to the Zero), and gave up after it had been compiling for 2-3 hours.
This means we need to “cross compile”, which just means we compile it on a different architecture (regular computer - x86) than we run it on (Raspberry Pi - ARM).</p>

<ol>
  <li>Get the Librespot source code from Github (link above).</li>
  <li>If using the Raspberry Pi Zero or a Raspberry Pi 1 as the audio server, you also need to do the following (because those models have an older version of ARM):
    <ol>
      <li>Get Raspberry Pi Tools from Github (see above).</li>
      <li>Edit .cargo/config as specified <a href="https://github.com/japaric/rust-cross/issues/42#issuecomment-506569303">here</a>.
Remember to edit the path to the linker to match where you placed the raspberrypi-tools repo.
Go ahead and remove the <code class="language-plaintext highlighter-rouge">target = "arm-unknown-linux-gnueabihf"</code> line, it gave me trouble.
We will instead specify the target when compiling, see below.</li>
    </ol>
  </li>
  <li>Follow <a href="https://github.com/librespot-org/librespot/wiki/Compiling">Librespot’s compiling guide</a>.
We will be using the Pipe backend which does not require any “features”:
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cargo build --release --no-default-features --target="arm-unknown-linux-gnueabihf"
</code></pre></div>    </div>
    <p>This took about 13 minutes on my cheap laptop, and should give you a single executable file called “librespot” somewhere inside the “target” folder (e.g. <code class="language-plaintext highlighter-rouge">target/arm-unknown-linux-gnueabihf/release</code>).</p>
  </li>
</ol>

<h1 id="prepare-the-raspberry-pis">Prepare the Raspberry Pis</h1>

<p>Download the latest Raspbian from the link above.
For this project, you just need the simplest one (E.g. Raspbian Buster Lite).</p>

<p>Now you need to flash Raspbian onto the SD card.
The download page has a link to a guide for this, which you can follow.</p>

<p>This is how I did it (though there looks to be even simpler methods available):</p>

<blockquote>
  <p>Insert the SD card into the reader.
Download balenaEtcher from the link above.
Open it and choose the Raspbian Zip file you downloaded and the SD card to flash, and start the process (Click “Flash!”).</p>
</blockquote>

<p>Once the flashing is complete, you should be able to open the SD card as a drive, possibly called “boot”.
Before removing the SD card, open the “boot” drive and do the following to simplify the setup process:</p>

<ol>
  <li>Create an empty file called “ssh” in the top level.
This will cause SSH to be enabled on bootup, so we can access the Raspberry Pi remotely. Otherwise, you need to hook up a screen and keyboard.</li>
  <li>Create a “wpa_supplicant.conf” file in the top level with info about your Wifi network, as described <a href="https://www.raspberrypi.org/documentation/configuration/wireless/headless.md">Raspberry Pi’s guide</a>.
This will allow the Raspberry Pi to connect to Wifi on its first boot, which is also needed for remote access.</li>
  <li>If you have a HifiBerry, edit config.txt as described in <a href="https://www.hifiberry.com/docs/software/configuring-linux-3-18-x/">HifiBerry’s guide</a>.
This enables the HifiBerry sound card.</li>
</ol>

<p>Note that the “boot” drive shows up the <code class="language-plaintext highlighter-rouge">/boot/</code> folder on the Raspberry Pi once it boots up.</p>

<h1 id="assemble-the-hardware">Assemble the hardware</h1>

<p>Plug in the SD card and mount the HifiBerry. If your Zero doesn’t have headers (the double row of pins for mounting the HifiBerry shield), you need to solder them on first, I used <a href="https://www.youtube.com/watch?v=UDdbaMk39tM">this video</a> to guide me. If you get the “Zero Wh” variant it has the headers already soldered on.</p>

<p>Plug in the power and wait for the Pi to boot up, which might take some extra minutes the first time.</p>

<p>You can go ahead and plug in the audio cables now if you want to, though there’s a bit more to do before we have sound.</p>

<h1 id="configure-the-raspberry-pis">Configure the Raspberry Pis</h1>

<p>Do the following for each Raspberry Pi you set up, both clients and server.</p>

<p>The Raspberry Pi should now have booted and connected to the Wifi network.
To continue, we need the IP address of the Raspberry Pi.
You could use something like <code class="language-plaintext highlighter-rouge">nmap</code>, but I had limited success with that.
Usually, you can log into your router and see all the devices connected to it.
If there are a lot, look for the ones called “raspberrypi” or something like that, or diconnect the Raspberry Pi and see which entry disappears.</p>

<p>When you have the IP address, SSH into it:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh pi@&lt;IP address&gt;
</code></pre></div></div>

<p>For example <code class="language-plaintext highlighter-rouge">ssh pi@10.0.0.5</code> (<code class="language-plaintext highlighter-rouge">pi</code> is the username). The password should be “raspberry”.</p>

<p>You should now run <a href="https://www.raspberrypi.org/documentation/configuration/raspi-config.md">raspi-config</a> and set a new password (for security, since SSH is enabled) and hostname (to distinguish different Pis from each other later, like when using Snapcast).</p>

<p>Also, do</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt update
sudo apt upgrade
</code></pre></div></div>

<p>to get the latest software updates.</p>

<h1 id="install-snapcast-and-librespot">Install Snapcast and Librespot</h1>

<p>From earlier, you should now have snapserver, snapclient and librespot ready.</p>

<p>Exit SSH now if you haven’t:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>exit
</code></pre></div></div>

<h2 id="clients">Clients</h2>

<p>Do the following for each client device.</p>

<p>Use <code class="language-plaintext highlighter-rouge">scp</code> (“copy over SSH”) to copy snapclient (note the colon after the IP address).</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scp &lt;path to download folder&gt;/&lt;snapclient name&gt; pi@&lt;IP address&gt;:
</code></pre></div></div>

<p>Note that you can access the <code class="language-plaintext highlighter-rouge">C:\</code> drive from WSL via <code class="language-plaintext highlighter-rouge">/mnt/c/</code>.</p>

<p>Now SSH back in and install the package.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt install ./&lt;snapclient name&gt;
</code></pre></div></div>

<p>Now we need to configure snapclient a tiny bit. Modify <code class="language-plaintext highlighter-rouge">SNAPCLIENT_OPTS</code> in <code class="language-plaintext highlighter-rouge">/etc/default/snapclient</code> to add the HifiBerry as the sound device:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SNAPCLIENT_OPTS="-s sndrpihifiberry"
</code></pre></div></div>

<p>To edit the file in a terminal, do <code class="language-plaintext highlighter-rouge">sudo nano &lt;filename&gt;</code> (you need <code class="language-plaintext highlighter-rouge">sudo</code> for files in <code class="language-plaintext highlighter-rouge">/etc/</code>).
The name “sndrpihifiberry” I found by calling <code class="language-plaintext highlighter-rouge">aplay -l</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ aplay -l
**** List of PLAYBACK Hardware Devices ****
card 0: sndrpihifiberry [snd_rpi_hifiberry_dac], device 0: HifiBerry DAC HiFi pcm5102a-hifi-0 [HifiBerry DAC HiFi pcm5102a-hifi-0]
  Subdevices: 1/1
  Subdevice #0: subdevice #0
</code></pre></div></div>

<p>If you have some other setup than the HifiBerry, check <code class="language-plaintext highlighter-rouge">aplay -l</code> for the name of the sound card.
That’s what I did to use my <a href="https://usa.yamaha.com/products/proaudio/mixers/mg_series_xu_model/index.html">MG10XU</a> as one of the clients.</p>

<p>Restart the client to read the new configuration.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo service snapclient restart
</code></pre></div></div>

<p>Now exit SSH.</p>

<h2 id="server">Server</h2>

<p>Do the following for the server device.</p>

<p>Copy snapserver and librespot using <code class="language-plaintext highlighter-rouge">scp</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scp &lt;path to download folder&gt;/&lt;snapserver name&gt; pi@&lt;IP address&gt;:
scp &lt;path to librespot build&gt;/librespot pi@&lt;IP address&gt;:
</code></pre></div></div>

<p>SSH back in and install the packages.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt install ./&lt;snapserver name&gt;
sudo mv librespot /usr/local/bin/librespot
</code></pre></div></div>

<p>To <a href="https://github.com/badaix/snapcast/blob/master/doc/player_setup.md#spotify">configure snapserver to use librespot</a>, add a <code class="language-plaintext highlighter-rouge">stream</code> entry to <code class="language-plaintext highlighter-rouge">/etc/snapserver.conf</code> (fill in your Spotify user name and password):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>stream = librespot:///librespot?name=Spotify&amp;username=&lt;spotify username&gt;&amp;password=&lt;spotify password&gt;&amp;devicename=Snapcast&amp;bitrate=320&amp;nomalize=true&amp;autoplay=false
</code></pre></div></div>

<p>Also remove any streams added by default (just write a <code class="language-plaintext highlighter-rouge">#</code> before the line to remove it).</p>

<p>Restart the server to read the new configuration.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo service snapserver restart
</code></pre></div></div>

<h1 id="play-music">Play music</h1>

<p>At this point, the server should show up as “Snapcast” in your Spotify under “Devices available” (should be a button located close to the play bar when playing music).
If you choose “Snapcast” and play a song, you should hear sound from all your clients, et voilà!
There might be a short delay, and also a bit of sputtering as the sound synchronizes.</p>

<h2 id="snapdroid">Snapdroid</h2>

<p>I recommend installing Snapdroid (available on Google Play) to have better control and overview over the system.
It allows you to see the names of the available clients, and to tweak the individual names, volumes and latencies for each client.
It also allows you to listen to the stream.</p>

<h2 id="snapnet">Snap.Net</h2>

<p>You can also install Snap.Net (get the installer from releases on Github) which does the same as Snapdroid, but on a Windows machine.
I use both, Snapdroid to control from anywhere and to debug issues, Snap.Net as a client in my office.</p>

<p>Enjoy!</p>

<p><a href="https://news.ycombinator.com/item?id=23278754"><em>Discussion on HN</em></a></p>

  </div></div>

    </section>
  </main>
</body>

</html>
